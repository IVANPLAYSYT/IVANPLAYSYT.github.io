<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RADIO IVANPLAY ESPA√ëA ‚Äî 24/7</title>
<meta name="description" content="Radio IVANPLAY ‚Äî AutoDJ 24/7 con m√∫sica variada, chat en vivo, emojis SVG, publicidad y audio-ads.">

<!-- ===== Seguridad (CSP) ===== -->
<meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.google.com https://www.googleapis.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    font-src 'self' data:;
    media-src 'self';
    connect-src 'self' https://api.countapi.xyz https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://www.googleapis.com;
    frame-src 'none';
    frame-ancestors 'none';
    base-uri 'none';
    form-action 'none';
    upgrade-insecure-requests;
  ">
<meta name="referrer" content="no-referrer">
<meta http-equiv="Permissions-Policy"
  content="
    geolocation=(),
    microphone=(),
    camera=(),
    payment=(),
    usb=(),
    interest-cohort=()
  ">

<style>
  :root{
    --bg:#0b0d12; --card:#121725; --text:#e7ecf3; --muted:#94a0b8;
    --a:#8b5cf6; --a2:#5b3dff; --ok:#14f195; --chip:#1b2340; --neon:#1fb6ff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;
    background:
      linear-gradient(180deg, rgba(7,10,18,.75), rgba(7,10,18,.85)),
      url('./assets/bg/pro-studio.jpg') center/cover no-repeat fixed;
    color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.25)
  }

  /* ====== BANNER ====== */
  .hero{
    position:relative; border-radius:22px; overflow:hidden;
    height:280px; margin:18px 0; display:grid; place-items:center;
    background:
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.65)),
      radial-gradient(1000px 600px at -10% 120%,rgba(31,182,255,.20),transparent 60%),
      radial-gradient(900px 500px at 110% -10%,rgba(139,92,246,.25),transparent 60%),
      var(--bg);
    background-size:cover; background-position:center;
  }
  .hero.has-image{
    background-image:
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.65)),
      var(--hero-image);
  }
  .hero-inner{ text-align:center; padding:0 16px }
  .neon{
    font-family: Impact, Haettenschweiler, 'Arial Black', sans-serif;
    font-size: clamp(28px, 5vw, 54px);
    color: var(--neon);
    text-shadow:
      0 0 6px  rgba(31,182,255,.9),
      0 0 16px rgba(31,182,255,.7),
      0 0 36px rgba(31,182,255,.55),
      0 0 64px rgba(31,182,255,.35);
    margin:0 0 6px; letter-spacing:.5px;
  }
  .neon-sub{color:#cfe9ff;font-weight:700;letter-spacing:2px;text-transform:uppercase}

  header.card{display:flex;gap:16px;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:12px}
  .brand .logo{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,#6a5cf6,#24d3ee)}
  .title{margin:0;font-size:28px}
  .muted{color:var(--muted)}
  .live{display:flex;align-items:center;gap:8px;font-size:12px;padding:5px 10px;border:1px solid rgba(255,255,255,.2);border-radius:999px}
  .dot{width:10px;height:10px;border-radius:50%;background:#16f195;box-shadow:0 0 8px #16f195;animation:pulse 1.5s infinite}
  @keyframes pulse{0%{transform:scale(.9);opacity:.8}50%{transform:scale(1);opacity:1}100%{transform:scale(.9);opacity:.8}}
  #onlineCount{margin-left:10px}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:18px}
  @media (max-width:950px){.grid{grid-template-columns:1fr}}

  .btn{cursor:pointer;border:none;padding:11px 14px;border-radius:12px;background:rgba(255,255,255,.06);color:var(--text);font-weight:700;border:1px solid rgba(255,255,255,.12)}
  .btn.primary{background:linear-gradient(180deg,var(--a),var(--a2));border:none;box-shadow:0 10px 24px rgba(139,92,246,.35)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"],textarea{width:100%;background:#0a0f1c;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  input[type="range"]{width:180px}
  #now{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  #chatLog{height:280px;overflow:auto;background:#0a0f1c;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px}
  .msg{margin:4px 0}
  #emoji{max-height:120px;overflow:auto;display:grid;grid-template-columns:repeat(10, 1fr);gap:6px}
  #emoji button{background:#1a2236;border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:6px;cursor:pointer}
  .emoji-font,#emoji button,#chatLog,#msg,#nick{
    font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui,"Segoe UI",Roboto,Arial,sans-serif;font-size:16px;line-height:1.15
  }
  footer{color:var(--muted);text-align:center;margin-top:16px}
  .socials{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:580px){.socials{grid-template-columns:1fr}}
  .soc{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;background:#0a0f1c;border:1px solid rgba(255,255,255,.08);text-decoration:none;color:var(--text);font-weight:700}
  .soc small{color:var(--muted);font-weight:500}
  .soc.disabled{opacity:.55;cursor:not-allowed;border-style:dashed}
  .soc .ico{width:22px;height:22px;display:inline-grid;place-items:center}
  .soc .txt{display:flex;flex-direction:column;line-height:1.15}
  .chips{display:flex;flex-wrap:wrap;gap:10px}
  .chip{background:var(--chip);border:1px solid rgba(36,211,238,.35);color:#cfefff;padding:6px 12px;border-radius:999px}

  /* EMOJIS */
  .emo{width:20px;height:20px;vertical-align:-3px}
  .adtag{color:var(--muted);font-size:12px;margin-top:6px;text-align:center}
</style>
</head>
<body>
<div class="wrap">

  <!-- BANNER -->
  <section id="hero" class="hero">
    <div class="hero-inner">
      <h1 class="neon">RADIO IVANPLAY ESPA√ëA</h1>
      <div class="neon-sub">24/7 MUSIC EXPERIENCE</div>
    </div>
  </section>

  <!-- Publicidad est√°tica: bloque grande debajo del banner -->
  <section class="card" style="margin:12px 0">
    <a href="#" target="_blank" rel="noopener" style="display:block;text-align:center">
      <img src="./assets/ads/banner_top_970x250.jpg" alt="Publicidad" style="max-width:100%;height:auto;border-radius:12px">
    </a>
    <div class="adtag">Publicidad</div>
  </section>

  <header class="card">
    <div class="brand">
      <div class="logo">üéß</div>
      <div>
        <h2 class="title" style="margin:0">Mi Radio Online</h2>
        <div class="muted">AutoDJ 24/7 ‚Ä¢ Chat en vivo ‚Ä¢ <span id="clock" title="Hora de Madrid (Europe/Madrid)"></span></div>
      </div>
    </div>
    <div class="live">
      <span class="dot"></span> EN VIVO
      <span id="onlineCount" class="muted">¬∑ 0 conectados</span>
    </div>
  </header>

  <!-- REPRODUCTOR + CHAT -->
  <section class="grid">
    <div class="card" id="playerCard">
      <h2 style="margin:4px 0 10px">Reproductor en vivo</h2>
      <div class="row">
        <button id="playBtn" class="btn primary">‚ñ∂ Reproducir</button>
        <button id="stopBtn" class="btn">‚ñ† Detener</button>
        <button id="prevBtn" class="btn">‚èÆ</button>
        <button id="nextBtn" class="btn">‚è≠</button>
        <label class="muted" style="display:flex;align-items:center;gap:8px">Volumen
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8">
        </label>
      </div>
      <p class="muted" id="status">Cargando playlist‚Ä¶</p>
      <p id="now">‚Äî</p>
      <audio id="audio" preload="none" crossorigin="anonymous"></audio>
      <div id="gate" class="row" style="display:none;margin-top:8px">
        <span class="muted">Pulsa para iniciar audio</span>
        <button id="startBtn" class="btn primary">Iniciar</button>
      </div>
      <p class="muted" style="margin-top:10px">Este stream puede incluir mensajes promocionales (audio-ads).</p>
    </div>

    <div>
      <div class="card">
        <h2 style="margin:4px 0 10px">Chat</h2>
        <div id="chatLog" class="emoji-font"></div>
        <div class="row" style="margin-top:8px">
          <input id="nick" type="text" placeholder="Tu nick" style="max-width:220px" class="emoji-font">
          <button id="saveNick" class="btn">Guardar</button>
        </div>
        <div class="row" style="margin-top:8px">
          <textarea id="msg" rows="2" placeholder="Escribe un mensaje‚Ä¶" class="emoji-font"></textarea>
          <button id="send" class="btn primary">Enviar</button>
        </div>
        <div id="emoji" style="margin-top:6px" class="emoji-font"></div>
        <p class="muted">Atajos: escribe <code>:ivanheadset:</code> o <code>:ivangame:</code> para los exclusivos.</p>
        <p class="muted">Chat interno. Si Firebase no est√° configurado, funciona en modo local.</p>
      </div>

      <!-- Publicidad est√°tica: bloque en columna chat -->
      <section class="card" style="margin-top:12px;text-align:center">
        <a href="#" target="_blank" rel="noopener" style="display:block">
          <img src="./assets/ads/sidebar_300x250.jpg" alt="Publicidad" style="max-width:100%;height:auto;border-radius:12px">
        </a>
        <div class="adtag">Publicidad</div>
      </section>
    </div>
  </section>

  <!-- REDES + G√âNEROS -->
  <section class="grid" style="margin-top:18px">
    <div class="card">
      <h2 style="margin:4px 0 12px">S√≠gueme</h2>
      <div class="socials" id="socials"></div>
    </div>
    <div class="card">
      <h2 style="margin:4px 0 12px">Emisi√≥n 24/7</h2>
      <p class="muted">M√∫sica variada las 24 horas del d√≠a. G√©neros habituales:</p>
      <div class="chips" id="chips"></div>
    </div>
  </section>

  <!-- === ESTAD√çSTICAS + COMPARTIR === -->
  <section class="grid" style="margin-top:18px">
    <div class="card">
      <h2 style="margin:4px 0 12px">Estad√≠sticas</h2>
      <div class="row" style="flex-wrap:wrap;gap:14px">
        <div>
          <div class="muted">Reproducciones hoy</div>
          <div id="statToday" style="font-size:22px;font-weight:800">0</div>
        </div>
        <div>
          <div class="muted">Canciones emitidas (este navegador)</div>
          <div id="statTotalLocal" style="font-size:22px;font-weight:800">0</div>
        </div>
        <div>
          <div class="muted">Visitas totales (opcional)</div>
          <div id="statVisits" style="font-size:22px;font-weight:800">‚Äî</div>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">* ‚ÄúVisitas totales‚Äù usa CountAPI (opcional).</p>
    </div>

    <div class="card">
      <h2 style="margin:4px 0 12px">Compartir la radio</h2>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="shareBtn" class="btn primary">üîó Compartir</button>
        <a class="btn" id="shareWa" target="_blank" rel="noopener">WhatsApp</a>
        <a class="btn" id="shareTg" target="_blank" rel="noopener">Telegram</a>
        <a class="btn" id="shareTw" target="_blank" rel="noopener">Twitter/X</a>
      </div>
      <p class="muted" style="margin-top:8px">¬°Comparte <code>https://ivanplaysyt.github.io/</code>!</p>
    </div>
  </section>

  <footer>¬© <span id="year"></span> RADIO IVANPLAY ¬∑ Hecho con ‚ô•</footer>
</div>

<!-- Firebase (CDN) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/* ======= CONFIGURA AQU√ç TU PROYECTO FIREBASE ======= */
window.FIREBASE_CONFIG = {
  apiKey:        "AIzaSyAIlX6svUMeb1_Q0Mn4WvxojDDTqtIYXv0",          /* <- pon tus valores reales */
  authDomain:    "ivanplayradio.firebaseapp.com",
  databaseURL:   "https://ivanplayradio-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:     "ivanplayradio",
  storageBucket: "ivanplayradio.firebasestorage.app",
  messagingSenderId: "114410018389",
  appId:         "1:114410018389:web:1d8c40b5baf8c51673e6dc"
};
window.FIREBASE_ENABLED = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey);
</script>

<script>
/* ================== CONFIG ================== */
const CONFIG = {
  PLAYLIST_JSON_URL: "./music/playlist.json",
  ADS_JSON_URL: "./music/anuncios.json",
  AUDIO_ADS_EVERY: 4,
  SHUFFLE: true,
  BANNER_URL: "./assets/banner.jpg",
  TW_BASE: "./assets/twemoji/",
  SOCIALS: [
    {name:"YouTube",   icon:"‚ñ∂Ô∏è", url:"https://www.youtube.com/@ivanplays8012"},
    {name:"Twitch",    icon:"üéÆ", url:"https://www.twitch.tv/ivanplays_offi"},
    {name:"SoundCloud",icon:"‚òÅÔ∏è", url:"https://soundcloud.com/ivanzombiz"}
  ],
  GENRES: ["Hardbass","Reggaeton","Electr√≥nica (EDM)","Deep House","Tech House","Hip Hop/Rap"],
  COUNTAPI_NAMESPACE: "ivanplayradio",
  COUNTAPI_KEY: "visitas_totales"
};

/* Emojis exclusivos */
window.CUSTOM_EMOJIS = [
  { short: ":ivanheadset:", src: "./assets/custom/ivan_headset.svg",   title: "Headset IVANPLAY" },
  { short: ":ivangame:",    src: "./assets/custom/ivan_controller.svg", title: "Gamepad IVANPLAY" }
];

/* ===== EMOJIS SVG LOCALES ‚Äì UNA PASADA ===== */
const EMO_EXT = ".svg";
const TW_BASE = CONFIG.TW_BASE;
const EMO_UNI = Array.from("üòÄüòÅüòÇü§£üòäüòâüòçüòòüòéüôÇü§îüôÉüò¥üòáüò°üò≠üôåüëèüëçüî•üéßüéµüé∂üé§üéºüéπü•Åüé∑üé∫üé∏");
function toCodepoints(str){ const out=[]; for(const ch of str){ out.push(ch.codePointAt(0).toString(16).toLowerCase()); } return out.join("-"); }
function toEntity(str){ let s=""; for(const ch of str){ s += "&#x"+ch.codePointAt(0).toString(16)+";"; } return s; }
const EMO_MAP = Object.fromEntries(EMO_UNI.map(e => [e, `${TW_BASE}${toCodepoints(e)}${EMO_EXT}`]));
function emojiImgTag(chr){
  const src = `${TW_BASE}${toCodepoints(chr)}${EMO_EXT}`;
  const ent = toEntity(chr);
  return `<img class="emo" src="${src}" alt="" data-f="${ent}" onerror="this.outerHTML=this.dataset.f">`;
}
function escapeForRegex(s){ return s.replace(/([.*+?^${}()|[\]\\\\])/g,"\\$1"); }
const EMO_REGEX = new RegExp("(?:"+EMO_UNI.map(escapeForRegex).join("|")+")","g");

/* ============ Utilidades UI ============ */
const $ = s => document.querySelector(s);
document.getElementById("year").textContent = new Date().getFullYear();
/* Banner */
(function(){ const hero = $("#hero"); if(CONFIG.BANNER_URL){ hero.style.setProperty("--hero-image", `url('${CONFIG.BANNER_URL}')`); hero.classList.add("has-image"); } })();
/* Reloj Europe/Madrid */
(function clock(){ const el = $("#clock"); function tick(){ const fmt = new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid',hour:'2-digit',minute:'2-digit',second:'2-digit',weekday:'short',day:'2-digit',month:'short'}); el.textContent = fmt.format(new Date()) + " (Madrid)"; } tick(); setInterval(tick, 1000); })();
/* Helpers */
function baseName(u){ try{const p=new URL(u,location.href); return decodeURIComponent(p.pathname.split('/').pop());}catch{return u;} }
function setStatus(msg, ok){ const el=$("#status"); el.textContent = msg; el.style.color = ok ? "#14f195" : "#ff7777"; }
function enc(u){ try{ const url=new URL(u,location.origin); url.pathname=url.pathname.split('/').map(encodeURIComponent).join('/'); return url.toString().replace(location.origin,""); } catch{ return u.split('/').map((seg,i)=> i===0?seg:encodeURIComponent(seg)).join('/'); } }

/* ================== PLAYER + AUDIO-ADS ================== */
const audio=$("#audio"), now=$("#now"), playBtn=$("#playBtn"), stopBtn=$("#stopBtn"), prevBtn=$("#prevBtn"), nextBtn=$("#nextBtn"), vol=$("#vol"), gate=$("#gate"), startBtn=$("#startBtn");
let playlist=[], ads=[], mixed=[], i=0;

function isAudio(u){ return /\.(mp3|wav|aac|m4a|ogg)$/i.test((u||'').split('?')[0]); }
async function fetchJSONSafe(url){ try{ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }

async function loadPlaylist(){
  const pl = await fetchJSONSafe(CONFIG.PLAYLIST_JSON_URL);
  if(!Array.isArray(pl) || !pl.length){ setStatus("playlist.json est√° vac√≠o o mal formateado", false); return; }
  const main = pl.filter(isAudio).map(u=>enc(u));
  if(CONFIG.SHUFFLE && main.length>1){
    for(let k=main.length-1;k>0;k--){ const j=Math.floor(Math.random()*(k+1)); [main[k],main[j]]=[main[j],main[k]]; }
  }
  const adsJson = await fetchJSONSafe(CONFIG.ADS_JSON_URL);
  ads = Array.isArray(adsJson) ? adsJson.filter(isAudio).map(u=>enc(u)) : [];
  mixed = [];
  const N = Math.max(2, parseInt(CONFIG.AUDIO_ADS_EVERY||4,10));
  let count=0;
  for(const track of main){
    mixed.push({url:track, type:"music"}); count++;
    if(ads.length && count>=N){ const pick = ads[Math.floor(Math.random()*ads.length)]; mixed.push({url:pick, type:"ad"}); count=0; }
  }
  playlist = mixed.length ? mixed : main.map(u=>({url:u,type:"music"}));
  i=0;
  setStatus(`Playlist cargada (${main.length} pistas${ads.length?` + ${ads.length} anuncios`:''})`, true);
  setTrack(i);
  setTimeout(tryAutoplay, 200);
}
function setTrack(idx){
  if(!playlist.length) return;
  i = (idx + playlist.length) % playlist.length;
  const item = playlist[i];
  audio.src = item.url;
  now.textContent = (item.type==="ad" ? "Anuncio: " : "Reproduciendo: ") + baseName(item.url);
  const b=$("#skipErr"); if(b) b.remove();
}
async function play(){ try{ if(!audio.src) setTrack(0); await audio.play(); gate.style.display="none"; playBtn.textContent="‚è∏ Pausar"; playBtn.classList.remove("primary"); }catch{ gate.style.display="flex"; } }
function pause(){ audio.pause(); playBtn.textContent="‚ñ∂ Reproducir"; playBtn.classList.add("primary"); }
function next(){ if(!playlist.length) return; setTrack(i+1); play(); }
function prev(){ if(!playlist.length) return; setTrack(i-1); play(); }
async function tryAutoplay(){ try{ await play(); }catch{} }
playBtn.addEventListener("click", ()=> audio.paused ? play() : pause());
stopBtn.addEventListener("click", ()=>{ audio.pause(); audio.currentTime=0; playBtn.textContent="‚ñ∂ Reproducir"; playBtn.classList.add("primary"); });
prevBtn.addEventListener("click", prev);
nextBtn.addEventListener("click", next);
startBtn.addEventListener("click", play);
vol.addEventListener("input", ()=> audio.volume=parseFloat(vol.value||"0.8"));
audio.volume=parseFloat(vol.value||"0.8");
audio.addEventListener("ended", next);
audio.addEventListener("error", ()=>{
  let d=""; try{ if(audio.error){ const m={1:"ABORTED",2:"NETWORK",3:"DECODE",4:"SRC_NOT_SUPPORTED"}; d=m[audio.error.code]||`ERR ${audio.error.code}`; } }catch{}
  setStatus(`Fallo al reproducir: ${baseName(audio.src)}${d? " ¬∑ "+d:""}`, false);
  if(!$("#skipErr")){
    const b=document.createElement("button");
    b.id="skipErr"; b.className="btn"; b.style.marginLeft="8px";
    b.textContent="Saltar error y continuar ‚è≠";
    b.onclick=()=>{ b.remove(); next(); };
    $("#status").after(b);
  }
});
document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="visible" && audio.paused){ tryAutoplay(); } });
loadPlaylist();

/* ================== Seguridad chat (escape, anti-flood, l√≠mites) ================== */
function escapeHTML(str){ const div = document.createElement("div"); div.textContent = String(str ?? ""); return div.innerHTML; }
function normalizeSpaces(s){ return String(s ?? "").replace(/\s+/g," ").trim(); }
function clampLen(s,max){ s=String(s??""); return (s.length>max)? s.slice(0,max): s; }
let LAST_MSG_TS = 0; const FLOOD_MS = 2500; const MAX_MSG_LEN = 500; const MAX_NICK_LEN = 24;

/* ================== ELEMENTOS CHAT / SOCIAL / EMOJI ================== */
const log  = $("#chatLog"), send = $("#send"), msg = $("#msg"), nick = $("#nick"), saveNick = $("#saveNick"), emojiBox = $("#emoji"), onlineEl = $("#onlineCount");
const CH_KEY = "ivanplay_chat_v1";
const bc = ("BroadcastChannel" in window) ? new BroadcastChannel("ivanplay_chat_v1") : null;

/* Picker emojis (SVG locales + exclusivos) */
function renderEmojiButtons(){
  if(!emojiBox) return; emojiBox.innerHTML="";
  EMO_UNI.forEach(e=>{
    const b=document.createElement("button");
    b.className="emoji-font"; b.style.padding="6px";
    const img=document.createElement("img");
    img.alt=""; img.width=20; img.height=20; img.decoding="async";
    const fallbackSrc = `${TW_BASE}${toCodepoints(e)}${EMO_EXT}`;
    img.src = EMO_MAP[e] || fallbackSrc;
    img.onerror = ()=>{ b.textContent = e; };
    b.appendChild(img);
    b.onclick=()=>{ msg.value += e; msg.focus(); };
    emojiBox.appendChild(b);
  });
  (window.CUSTOM_EMOJIS||[]).forEach(e=>{
    const b=document.createElement("button");
    b.className="emoji-font"; b.style.padding="6px";
    const img=document.createElement("img");
    img.src=e.src; img.alt=""; img.width=20; img.height=20; img.decoding="async";
    img.onerror = ()=>{ b.textContent = e.short; };
    b.appendChild(img); b.title=e.title||"";
    b.onclick=()=>{ msg.value += " " + e.short + " "; msg.focus(); };
    emojiBox.appendChild(b);
  });
}
renderEmojiButtons();

/* Utilidades Chat */
function getNick(){
  let n = normalizeSpaces(nick.value || localStorage.getItem("ivanplay_nick") || "");
  n = clampLen(n || ("User"+Math.floor(Math.random()*900+100)), MAX_NICK_LEN);
  nick.value = n; localStorage.setItem("ivanplay_nick", n);
  return n;
}
function renderMsg(obj){
  if(!log) return;
  const nickSafe = clampLen(escapeHTML(obj.u ?? "Invitado"), MAX_NICK_LEN);
  const timeSafe = escapeHTML(obj.t ?? "");
  const body = String(obj.m ?? "");
  const p=document.createElement("div");
  p.className="msg"+(obj.sys?" sys":"");
  p.innerHTML = `[${timeSafe}] ${nickSafe}: ${body}`;
  log.appendChild(p);
  log.scrollTop=log.scrollHeight;
}

/* ===================== Filtro anti-spam / insultos ===================== */
const SPAM = {
  blacklist: [
    "puta","puto","mierda","joder","cabr√≥n","cabron","gilipollas","hdp","imbecil",
    "estafa","scam","porno","xxx","sex","nazi","racista","negro de mierda"
  ],
  allowDomains: [
    "ivanplaysyt.github.io","twitch.tv","youtube.com","youtu.be","x.com","twitter.com","soundcloud.com"
  ],
  maxEmojis: 20,
  maxRepeatChar: 4,
  maxShouting: 0.85,
  minMsgLen: 1,
  maxMsgLen: 200
};
function cleanUnicode(s){ return String(s||"").replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\u00A0/g," ").replace(/\s+/g," ").trim(); }
function countEmojis(s){ const re=/([\p{Extended_Pictographic}])|(<img[^>]+class="emo"[^>]*>)/gu; return (String(s).match(re)||[]).length; }
function hasForbiddenLink(s){
  const urlRe=/\bhttps?:\/\/[^\s)]+/gi; const found=String(s).match(urlRe)||[];
  if(found.length===0) return false;
  return found.some(u=>{ try{ const h=new URL(u).hostname.replace(/^www\./,"").toLowerCase(); return !SPAM.allowDomains.some(ad=>h.endsWith(ad)); }catch{ return true; }});
}
function shoutingRatio(s){ const letters=(String(s).match(/[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]/g)||[]); if(!letters.length) return 0; const caps=(String(s).match(/[A-Z√Å√â√ç√ì√ö√ú√ë]/g)||[]).length; return caps/letters.length; }
function clampRepeats(s){ return String(s).replace(/(.)\1{5,}/g,(m,ch)=>ch.repeat(SPAM.maxRepeatChar)); }
function hashStr(s){ let h=0; s=String(s); for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return h.toString(16); }
function filterMessage(raw){
  let msg = cleanUnicode(raw);
  if(msg.length < SPAM.minMsgLen) return {ok:false, reason:"Mensaje vac√≠o."};
  if(msg.length > SPAM.maxMsgLen) msg = msg.slice(0, SPAM.maxMsgLen);
  if(hasForbiddenLink(msg)) return {ok:false, reason:"Enlaces externos no permitidos."};
  const low = msg.toLowerCase();
  if(SPAM.blacklist.some(w => low.includes(w))) return {ok:false, reason:"Lenguaje no permitido."};
  if(countEmojis(msg) > SPAM.maxEmojis) return {ok:false, reason:"Demasiados emojis."};
  if(shoutingRatio(msg) > SPAM.maxShouting) msg = msg.toLowerCase();
  msg = clampRepeats(msg);
  const n = getNick(); const key="dup_"+n; const h=hashStr(msg);
  if(sessionStorage.getItem(key) === h) return {ok:false, reason:"Mensaje repetido."};
  sessionStorage.setItem(key, h);
  return {ok:true, cleaned: msg};
}

/* ===== Fallback local (sin Firebase) ===== */
function loadChatLocal(){ try{ (JSON.parse(localStorage.getItem(CH_KEY)||"[]")).slice(-200).forEach(renderMsg);}catch{} }
function storeLocal(o){ try{ const a=JSON.parse(localStorage.getItem(CH_KEY)||"[]"); a.push(o); localStorage.setItem(CH_KEY, JSON.stringify(a.slice(-300))); }catch{} }
function sendLocal(){
  const nowTs = Date.now(); if (nowTs - LAST_MSG_TS < FLOOD_MS) return;
  const n = getNick(); let m = normalizeSpaces(msg.value); if(!m) return;

  const f = filterMessage(m);
  if(!f.ok){ renderMsg({t:new Date().toLocaleTimeString(), u:"Sistema", m:`${escapeHTML(f.reason)} üö´`, sys:true}); return; }
  m = f.cleaned;

  let safe = escapeHTML(m);
  (window.CUSTOM_EMOJIS||[]).forEach(e=>{ const re=new RegExp(e.short.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'),"g"); safe = safe.replace(re, `<img class="emo" src="${e.src}" alt="">`); });
  safe = safe.replace(EMO_REGEX, chr => emojiImgTag(chr));

  const o = { t:new Date().toLocaleTimeString(), u:n, m:safe, sys:false };
  renderMsg(o); storeLocal(o); if(bc) bc.postMessage(o);
  LAST_MSG_TS = nowTs; msg.value="";
}
function bindLocal(){
  send.onclick = sendLocal;
  msg.onkeydown = (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter") sendLocal(); };
  if(bc) bc.onmessage = ev=>{ if(ev&&ev.data) renderMsg(ev.data); };
  renderMsg({t:new Date().toLocaleTimeString(),u:"Sistema",m:"Chat local activo üí¨ (sincroniza pesta√±as)",sys:true});
  loadChatLocal();
  if (onlineEl) onlineEl.textContent = "¬∑ 1 conectado (t√∫)";
}

/* ===== Firebase RTDB (chat global + contador online) ===== */
function bindFirebase(){
  const app = firebase.initializeApp(window.FIREBASE_CONFIG);
  const db  = firebase.database();
  const room = "global";

  // presencia (usuarios)
  const uid  = (Math.random().toString(36).slice(2,10)) + Date.now().toString(36);
  const myRef = db.ref(`presence/${room}/${uid}`);
  const info  = db.ref(".info/connected");
  info.on("value", snap=>{
    if (snap.val() === true){
      myRef.onDisconnect().remove();
      myRef.set({nick: getNick(), online:true, ts: firebase.database.ServerValue.TIMESTAMP});
    }
  });
  db.ref(`presence/${room}`).on("value", snap=>{
    const val = snap.val()||{}; const count = Object.keys(val).length;
    if (onlineEl) onlineEl.textContent = `¬∑ ${count} conectado${count===1?"":"s"}`;
  });

  // mensajes
  const messagesRef = db.ref(`rooms/${room}/messages`);
  messagesRef.limitToLast(100).on("child_added", (snap)=>{
    const o = snap.val(); if (!o) return; renderMsg(o);
  });

  async function sendFirebase(){
    const nowTs = Date.now(); if (nowTs - LAST_MSG_TS < FLOOD_MS) return;
    const n = getNick(); let m = normalizeSpaces(msg.value); if(!m) return;

    const f = filterMessage(m);
    if(!f.ok){ renderMsg({t:new Date().toLocaleTimeString(), u:"Sistema", m:`${escapeHTML(f.reason)} üö´`, sys:true}); return; }
    m = f.cleaned;

    let safe = escapeHTML(m);
    (window.CUSTOM_EMOJIS||[]).forEach(e=>{ const re=new RegExp(e.short.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'),"g"); safe = safe.replace(re, `<img class="emo" src="${e.src}" alt="">`); });
    safe = safe.replace(EMO_REGEX, chr => emojiImgTag(chr));

    const o = { t:new Date().toLocaleTimeString(), u:n, m:safe, sys:false };
    await messagesRef.push(o);
    LAST_MSG_TS = nowTs; msg.value="";
  }
  send.onclick = sendFirebase;
  msg.onkeydown = (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==="Enter") sendFirebase(); };

  renderMsg({t:new Date().toLocaleTimeString(),u:"Sistema",m:"Chat en vivo conectado ‚úÖ",sys:true});
}

/* Arranque h√≠brido */
try{ if (window.FIREBASE_ENABLED) bindFirebase(); else bindLocal(); }
catch(e){ console.warn("Firebase no disponible, uso local:", e); bindLocal(); }

/* Guardar nick */
saveNick.addEventListener("click", ()=>{ localStorage.setItem("ivanplay_nick", getNick()); renderMsg({t:new Date().toLocaleTimeString(),u:"Sistema",m:"Nick guardado",sys:true}); });
nick.value = localStorage.getItem("ivanplay_nick") || "";

/* ================== REDES + G√âNEROS ================== */
const socials=$("#socials"), chips=$("#chips");
CONFIG.SOCIALS.forEach(s=>{
  const hasLink=!!(s.url&&s.url.trim());
  const base=document.createElement(hasLink?"a":"div");
  base.className="soc emoji-font"+(hasLink?"":" disabled");
  if(hasLink){ base.href=s.url; base.target="_blank"; base.rel="noopener"; }
  const host=hasLink? new URL(s.url).hostname : "Pr√≥ximamente";
  base.innerHTML=`<span class="ico">${s.icon}</span><div class="txt"><div>${s.name}</div><small>${host}</small></div>`;
  socials.appendChild(base);
});
CONFIG.GENRES.forEach(g=>{ const c=document.createElement("span"); c.className="chip"; c.textContent=g; chips.appendChild(c); });

/* ========== Durezas opcionales ========== */
if (top !== self) { try { top.location = self.location; } catch(_){} }
document.addEventListener("dragstart", e => { if (e.target.closest("img,a,button")) e.preventDefault(); });
document.addEventListener("contextmenu", e => e.preventDefault());

/* ================== ESTAD√çSTICAS ================== */
const LS_TODAY="ivanplay_stats_today", LS_TODAY_D="ivanplay_stats_today_date", LS_TOTAL="ivanplay_stats_total";
function statResetIfDayChanged(){ const today=new Date().toISOString().slice(0,10); const saved=localStorage.getItem(LS_TODAY_D); if (saved!==today){ localStorage.setItem(LS_TODAY_D,today); localStorage.setItem(LS_TODAY,"0"); } }
function statIncToday(){ statResetIfDayChanged(); let v=parseInt(localStorage.getItem(LS_TODAY)||"0",10)+1; localStorage.setItem(LS_TODAY,String(v)); updateStatsUI(); }
function statIncTotal(){ let v=parseInt(localStorage.getItem(LS_TOTAL)||"0",10)+1; localStorage.setItem(LS_TOTAL,String(v)); updateStatsUI(); }
function updateStatsUI(){ const t=parseInt(localStorage.getItem(LS_TODAY)||"0",10), g=parseInt(localStorage.getItem(LS_TOTAL)||"0",10); const $t=$("#statToday"), $g=$("#statTotalLocal"); if($t) $t.textContent=t; if($g) $g.textContent=g; }
statResetIfDayChanged(); updateStatsUI();
async function fetchVisits(){ const ns=CONFIG.COUNTAPI_NAMESPACE||"", key=CONFIG.COUNTAPI_KEY||"", el=$("#statVisits"); if(!el) return; if(!ns||!key){ el.textContent="‚Äî"; return; } try{ const url=`https://api.countapi.xyz/hit/${encodeURIComponent(ns)}/${encodeURIComponent(key)}`; const r=await fetch(url,{cache:"no-store"}); const j=await r.json(); el.textContent=(j&&typeof j.value==="number")?j.value:"‚Äî"; }catch{ el.textContent="‚Äî"; } }
fetchVisits();

/* ================== COMPARTIR ================== */
(function initShare(){
  const url="https://ivanplaysyt.github.io/", text="üéß Radio IVANPLAY ‚Äî m√∫sica 24/7. ¬°Entra ya!", title="Radio IVANPLAY";
  const $btn=$("#shareBtn"), $wa=$("#shareWa"), $tg=$("#shareTg"), $tw=$("#shareTw");
  if($btn){ $btn.onclick=async()=>{ if(navigator.share){ try{ await navigator.share({title,text,url}); }catch{} }else{ try{ await navigator.clipboard.writeText(url); $btn.textContent="Copiado ‚úÖ"; setTimeout(()=>{$btn.textContent="üîó Compartir";},1500);}catch{} } }; }
  if($wa) $wa.href=`https://wa.me/?text=${encodeURIComponent(text+" "+url)}`;
  if($tg) $tg.href=`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`;
  if($tw) $tw.href=`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
})();

/* ================== CU√ëAS PROGRAMADAS ================== */
let lastHourFired=null;
function shouldFireHourly(){
  if (CONFIG.JINGLE_SCHEDULE==="hourly"){
    const h=new Date().getHours();
    if (lastHourFired===h) return false;
    return (new Date().getMinutes()===0);
  }
  if (Array.isArray(CONFIG.JINGLE_SCHEDULE)){
    const now=new Date(), hh=String(now.getHours()).padStart(2,"0"), mm=String(now.getMinutes()).padStart(2,"0"), curr=`${hh}:${mm}`;
    if (CONFIG.JINGLE_SCHEDULE.includes(curr)){ const key=`fired_${curr}_${now.toDateString()}`; if(sessionStorage.getItem(key)) return false; sessionStorage.setItem(key,"1"); return true; }
  }
  return false;
}
function enqueueJingleNext(){
  if(!Array.isArray(CONFIG.JINGLE_URLS)||!CONFIG.JINGLE_URLS.length) return;
  const pick=CONFIG.JINGLE_URLS[Math.floor(Math.random()*CONFIG.JINGLE_URLS.length)];
  if (Array.isArray(playlist)&&playlist.length){ playlist.splice(i+1,0,{url:pick,type:"ad"}); }
}
setInterval(()=>{ if(shouldFireHourly()){ enqueueJingleNext(); lastHourFired=new Date().getHours(); } },20000);
// Estad√≠sticas: tema iniciado (no anuncios)
audio.addEventListener("playing", ()=>{ try{ const item=(playlist&&playlist[i])?playlist[i]:null; if(item&&item.type==="music"){ statIncToday(); statIncTotal(); } }catch{} });
</script>
</body>
</html>

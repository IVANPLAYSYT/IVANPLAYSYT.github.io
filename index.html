<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RADIO IVANPLAY ESPA√ëA ‚Äî 24/7</title>
<meta name="description" content="Radio IVANPLAY ‚Äî AutoDJ 24/7 con m√∫sica variada, chat en vivo, emojis, publicidad (desktop+mobile) y login.">
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https: data: blob:;
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;
  script-src-elem 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;
  style-src 'self' 'unsafe-inline' https:;
  img-src 'self' data: blob: https:;
  font-src 'self' data: https:;
  media-src 'self' https: data:;
  connect-src 'self' https: wss: data: blob:;
  frame-src https: data: blob:;
  base-uri 'none'; form-action 'none'; upgrade-insecure-requests;">
<link rel="icon" href="/favicon.ico">
<style>
  :root{--bg:#0b0d12;--card:#121725;--text:#e7ecf3;--muted:#94a0b8;--a:#8b5cf6;--a2:#5b3dff;--ok:#14f195;--chip:#1b2340;--neon:#1fb6ff}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#0b0d12;color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:22px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .hero{position:relative;border-radius:22px;overflow:hidden;height:260px;margin:18px 0;display:grid;place-items:center;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.65)), url('./assets/bg/ivanplay_gamer_bg.jpg') center/cover no-repeat}
  .hero-inner{text-align:center;padding:0 16px}
  .neon{font-size:clamp(28px,5vw,54px);color:var(--neon);text-shadow:0 0 6px rgba(31,182,255,.9),0 0 36px rgba(31,182,255,.55);margin:0 0 6px}
  .neon-sub{color:#cfe9ff;font-weight:700;letter-spacing:2px;text-transform:uppercase}
  header.card{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,#6a5cf6,#24d3ee)}
  .title{margin:0;font-size:28px}
  .muted{color:var(--muted)}
  .live{display:flex;align-items:center;gap:8px;font-size:12px;padding:5px 10px;border:1px solid rgba(255,255,255,.2);border-radius:999px}
  .dot{width:10px;height:10px;border-radius:50%;background:#16f195;box-shadow:0 0 8px #16f195;animation:pulse 1.5s infinite}
  @keyframes pulse{0%{transform:scale(.9);opacity:.8}50%{transform:scale(1);opacity:1}100%{transform:scale(.9);opacity:.8}}
  #onlineCount{margin-left:10px}
  .nav{display:flex;gap:8px}.chip{background:var(--chip);border:1px solid rgba(36,211,238,.35);color:#cfefff;padding:6px 12px;border-radius:999px;text-decoration:none}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;margin-top:18px}
  @media (max-width:950px){.grid{grid-template-columns:1fr}}
  .btn{cursor:pointer;border:none;padding:11px 14px;border-radius:12px;background:rgba(255,255,255,.06);color:var(--text);font-weight:700;border:1px solid rgba(255,255,255,.12)}
  .btn.primary{background:linear-gradient(180deg,var(--a),var(--a2));border:none;box-shadow:0 10px 24px rgba(139,92,246,.35)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="email"],input[type="password"],textarea{width:100%;background:#0a0f1c;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  input[type="range"]{width:180px}
  #chatLog{height:280px;overflow:auto;background:#0a0f1c;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px}
  .adtag{color:var(--muted);font-size:12px;margin-top:6px;text-align:center}
  footer{color:var(--muted);text-align:center;margin-top:16px}
  .socials{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:580px){.socials{grid-template-columns:1fr}}
  .soc{display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;background:#0a0f1c;border:1px solid rgba(255,255,255,.08);text-decoration:none;color:var(--text);font-weight:700}
  .soc small{color:var(--muted);font-weight:500}
  .soc .ico{width:22px;height:22px;display:inline-grid;place-items:center}
  .soc .txt{display:flex;flex-direction:column;line-height:1.15}
</style>
</head>
<body>
<div class="wrap">

  <section class="hero">
    <div class="hero-inner">
      <h1 class="neon">RADIO IVANPLAY ESPA√ëA</h1>
      <div class="neon-sub">24/7 MUSIC EXPERIENCE</div>
    </div>
  </section>

  <div id="ad-desktop-top" class="ad-slot ad-top ad-card" aria-label="Publicidad" style="text-align:center;margin:12px auto 20px">
    <script async="async" data-cfasync="false" src="//pl27907252.effectivegatecpm.com/715307b74d25ae971c432e0fec096290/invoke.js"></script>
    <div id="container-715307b74d25ae971c432e0fec096290"></div>
  </div>
  <style>@media(max-width:600px){ #ad-desktop-top{ display:none !important } }</style>

  <style>
    .ad-gate{position:fixed;inset:0;z-index:9999;display:none}
    .ad-gate.show{display:block}.ad-gate__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.75)}
    .ad-gate__panel{position:relative;max-width:420px;width:92vw;max-height:80vh;margin:8vh auto;background:#0f1222;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden}
    .ad-gate__header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px;background:linear-gradient(180deg,#181c35,#141932);color:#cfd3ff;font-size:14px}
    .ad-gate__close{border:0;background:#23284b;color:#aab1ff;border-radius:10px;width:36px;height:32px;cursor:not-allowed;opacity:.5;transition:.2s}
    .ad-gate__close.enabled{cursor:pointer;opacity:1}.ad-gate__body{padding:10px;background:#0e1122}
    @media(min-width:601px){.ad-gate{display:none !important}}
  </style>
  <div id="adGate" class="ad-gate" aria-modal="true" role="dialog">
    <div class="ad-gate__backdrop" aria-hidden="true"></div>
    <div class="ad-gate__panel" role="document">
      <div class="ad-gate__header">
        <div><strong>Publicidad</strong> ¬∑ se cerrar√° en <span id="adGateCountdown">5</span>s</div>
        <button id="adGateClose" class="ad-gate__close" disabled>‚úï</button>
      </div>
      <div class="ad-gate__body"><div id="adGateMount"></div></div>
      <p style="color:#98a1c7;text-align:center;margin:8px 0 12px">Gracias por apoyar a RADIO IVANPLAY.</p>
    </div>
  </div>

  <header class="card">
    <div class="brand">
      <div class="logo">üéß</div>
      <div>
        <h2 class="title" style="margin:0">Mi Radio Online</h2>
        <div class="muted">AutoDJ 24/7 ‚Ä¢ <span id="clock"></span></div>
      </div>
    </div>
    <div class="live"><span class="dot"></span> EN VIVO <span id="onlineCount" class="muted">¬∑ 0 conectados</span></div>
    <nav class="nav">
      <a class="chip" href="/">Inicio</a>
      <a class="chip" href="/store.html">Tienda</a>
    </nav>
    <div class="row">
      <span id="userName" class="muted" style="display:none"></span>
      <button id="btnLogin" class="btn">Entrar</button>
      <button id="btnLogout" class="btn" style="display:none">Salir</button>
    </div>
  </header>

  <section class="grid">
    <div class="card" id="playerCard">
      <h2 style="margin:4px 0 10px">Reproductor en vivo</h2>
      <div class="row">
        <button id="playBtn" class="btn primary">‚ñ∂ Reproducir</button>
        <button id="stopBtn" class="btn">‚ñ† Detener</button>
        <button id="prevBtn" class="btn">‚èÆ</button>
        <button id="nextBtn" class="btn">‚è≠</button>
        <label class="muted" style="display:flex;align-items:center;gap:8px">Volumen <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8"></label>
      </div>
      <p class="muted" id="status">Cargando playlist‚Ä¶</p>
      <p id="now">‚Äî</p>
      <audio id="audio" preload="none" crossorigin="anonymous"></audio>
      <div id="gate" class="row" style="display:none;margin-top:8px"><span class="muted">Pulsa para iniciar audio</span><button id="startBtn" class="btn primary">Iniciar</button></div>

      <div id="ad-mobile-bottom" style="margin:14px auto;text-align:center;">
        <script type="text/javascript">
          window.atOptions = {"key":"eb062868b77321037f2f1dac96cff625","format":"iframe","height":50,"width":320,"params":{}};
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/eb062868b77321037f2f1dac96cff625/invoke.js"></script>
        <div class="adtag">Publicidad</div>
      </div>
      <style>@media (min-width:601px){ #ad-mobile-bottom{ display:none !important } }</style>
    </div>

    <div>
      <div class="card">
        <h2 style="margin:4px 0 10px">Chat</h2>
        <div id="chatLog"></div>
        <div class="row" style="margin-top:8px">
          <input id="nick" type="text" placeholder="Tu nick" style="max-width:220px">
          <button id="saveNick" class="btn">Guardar</button>
        </div>
        <div class="row" style="margin-top:8px">
          <textarea id="msg" rows="2" placeholder="Entra para chatear (Google / Email)" disabled></textarea>
          <button id="send" class="btn primary">Enviar</button>
        </div>
        <p class="muted">Para escribir: inicia sesi√≥n. Para escribir: inicia sesi√≥n.</p>
      </div>

      <section class="card" style="margin-top:12px;text-align:center">
        <a href="#" target="_blank" rel="noopener" style="display:block">
          <img src="./assets/ads/sidebar_300x250.jpg" alt="Publicidad" style="max-width:100%;height:auto;border-radius:12px">
        </a>
        <div class="adtag">Publicidad</div>
      </section>
    </div>
  </section>

  <section class="grid" style="margin-top:18px">
    <div class="card">
      <h2 style="margin:4px 0 12px">S√≠gueme</h2>
      <div class="socials" id="socials"></div>
    </div>
    <div class="card">
      <h2 style="margin:4px 0 12px">Emisi√≥n 24/7</h2>
      <p class="muted">M√∫sica variada 24/7. G√©neros habituales:</p>
      <div class="row" id="chips" style="flex-wrap:wrap"></div>
    </div>
  </section>

  <section class="grid" style="margin-top:18px">
    <div class="card">
      <h2 style="margin:4px 0 12px">Estad√≠sticas</h2>
      <div class="row" style="flex-wrap:wrap;gap:14px">
        <div><div class="muted">Reproducciones hoy</div><div id="statToday" style="font-size:22px;font-weight:800">0</div></div>
        <div><div class="muted">Canciones emitidas (este navegador)</div><div id="statTotalLocal" style="font-size:22px;font-weight:800">0</div></div>
        <div><div class="muted">Visitas totales</div><div id="statVisits" style="font-size:22px;font-weight:800">‚Äî</div></div>
      </div>
    </div>
    <div class="card">
      <h2 style="margin:4px 0 12px">Compartir la radio</h2>
      <div class="row" style="gap:10px;flex-wrap:wrap">
        <button id="shareBtn" class="btn primary">üîó Compartir</button>
        <a class="btn" id="shareWa" target="_blank" rel="noopener">WhatsApp</a>
        <a class="btn" id="shareTg" target="_blank" rel="noopener">Telegram</a>
        <a class="btn" id="shareTw" target="_blank" rel="noopener">Twitter/X</a>
      </div>
      <p class="muted" style="margin-top:8px">Comparte <code>https://ivanplaysyt.github.io/</code></p>
    </div>
  </section>

  <footer>¬© <span id="year"></span> RADIO IVANPLAY ¬∑ Hecho con ‚ô•</footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
window.FIREBASE_CONFIG = {
  apiKey:"AIzaSyAIlX6svUMeb1_Q0Mn4WvxojDDTqtIYXv0",
  authDomain:"ivanplayradio.firebaseapp.com",
  databaseURL:"https://ivanplayradio-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:"ivanplayradio",
  storageBucket:"ivanplayradio.firebasestorage.app",
  messagingSenderId:"114410018389",
  appId:"1:114410018389:web:1d8c40b5baf8c51673e6dc"
};
window.FIREBASE_ENABLED = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey);
if (window.FIREBASE_ENABLED) { try { firebase.initializeApp(window.FIREBASE_CONFIG); } catch(e){} }
</script>

<script>
var CONFIG = {
  PLAYLIST_JSON_URL: "./music/playlist.json",
  ADS_JSON_URL: "./music/anuncios.json",
  AUDIO_ADS_EVERY: 4,
  SHUFFLE: true,
  TW_BASE: "./assets/twemoji/",
  SOCIALS: [
    {name:"YouTube",   icon:"‚ñ∂Ô∏è", url:"https://www.youtube.com/@ivanplays8012"},
    {name:"Twitch",    icon:"üéÆ", url:"https://www.twitch.tv/ivanplays_offi"},
    {name:"SoundCloud",icon:"‚òÅÔ∏è", url:"https://soundcloud.com/ivanzombiz"}
  ],
  GENRES: ["Hardbass","Reggaeton","Electr√≥nica (EDM)","Deep House","Tech House","Hip Hop/Rap"],
  COUNTAPI_NAMESPACE: "ivanplayradio",
  COUNTAPI_KEY: "visitas_totales"
};
function $(s){return document.querySelector(s);}
document.getElementById("year").textContent = new Date().getFullYear();
(function(){var el=$("#clock");function tick(){el.textContent=new Intl.DateTimeFormat('es-ES',{timeZone:'Europe/Madrid',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date())+" (Madrid)";}tick();setInterval(tick,1000);} )();
(function(){var s=$("#socials"),c=$("#chips");(CONFIG.SOCIALS||[]).forEach(function(o){var a=document.createElement("a");a.className="soc";a.href=o.url;a.target="_blank";a.rel="noopener";a.innerHTML='<span class="ico">'+o.icon+'</span><div class="txt"><div>'+o.name+'</div><small>'+new URL(o.url).hostname+'</small></div>';s.appendChild(a);});(CONFIG.GENRES||[]).forEach(function(g){var b=document.createElement("span");b.className="chip";b.textContent=g;c.appendChild(b);});})();
</script>
  
/* Emojis exclusivos */
window.CUSTOM_EMOJIS = [
  { short: ":ivanheadset:", src: "./assets/custom/ivan_headset.svg",   title: "Headset IVANPLAY" },
  { short: ":ivangame:",    src: "./assets/custom/ivan_controller.svg", title: "Gamepad IVANPLAY" }
];

/* ===== EMOJIS SVG LOCALES ‚Äì UNA PASADA ===== */
const EMO_EXT = ".svg";
const TW_BASE = CONFIG.TW_BASE;
const EMO_UNI = Array.from("üòÄüòÅüòÇü§£üòäüòâüòçüòòüòéüôÇü§îüôÉüò¥üòáüò°üò≠üôåüëèüëçüî•üéßüéµüé∂üé§üéºüéπü•Åüé∑üé∫üé∏");
function toCodepoints(str){ const out=[]; for(const ch of str){ out.push(ch.codePointAt(0).toString(16).toLowerCase()); } return out.join("-"); }
function toEntity(str){ let s=""; for(const ch of str){ s += "&#x"+ch.codePointAt(0).toString(16)+";"; } return s; }
const EMO_MAP = Object.fromEntries(EMO_UNI.map(e => [e, `${TW_BASE}${toCodepoints(e)}${EMO_EXT}`]));
function emojiImgTag(chr){
  const src = `${TW_BASE}${toCodepoints(chr)}${EMO_EXT}`;
  const ent = toEntity(chr);
  return `<img class="emo" src="${src}" alt="" data-f="${ent}" onerror="this.outerHTML=this.dataset.f">`;
}
function escapeForRegex(s){ return s.replace(/([.*+?^${}()|[\]\\\\])/g,"\\$1"); }
const EMO_REGEX = new RegExp("(?:"+EMO_UNI.map(escapeForRegex).join("|")+")","g");
  
<script>
var audio=$("#audio"), now=$("#now"), playBtn=$("#playBtn"), stopBtn=$("#stopBtn"), prevBtn=$("#prevBtn"), nextBtn=$("#nextBtn"), vol=$("#vol"), gate=$("#gate"), startBtn=$("#startBtn");
var playlist=[], ads=[], mixed=[], i=0;
function isAudio(u){return/\.(mp3|wav|aac|m4a|ogg)$/i.test((u||'').split('?')[0]);}
async function fetchJSONSafe(url){try{var r=await fetch(url,{cache:"no-store"});if(!r.ok)return null;return await r.json();}catch{return null;}}
function setStatus(msg, ok){var el=$("#status"); if(el){ el.textContent=msg; el.style.color = ok ? "#14f195" : "#ff7777"; }}
(async function loadPlaylist(){var pl=await fetchJSONSafe(CONFIG.PLAYLIST_JSON_URL);if(!Array.isArray(pl)||!pl.length){ setStatus("playlist.json vac√≠o o incorrecto", false); return; }var main = pl.filter(isAudio);var adsJson = await fetchJSONSafe(CONFIG.ADS_JSON_URL);ads = Array.isArray(adsJson) ? adsJson.filter(isAudio) : [];mixed = []; var count=0; var N=Math.max(2, parseInt(CONFIG.AUDIO_ADS_EVERY||4,10));for(var k=0;k<main.length;k++){ mixed.push({url:main[k], type:"music"}); count++; if(ads.length && count>=N){ mixed.push({url:ads[Math.floor(Math.random()*ads.length)], type:"ad"}); count=0; } }playlist = mixed.length ? mixed : main.map(function(u){return {url:u,type:"music"};});i=0; setStatus("Playlist cargada ("+main.length+" pistas)", true); setTrack(i);})();
function setTrack(idx){ if(!playlist.length) return; i=(idx+playlist.length)%playlist.length; var item=playlist[i]; audio.src=item.url; var name=item.url.split('/').pop(); if(now) now.textContent=(item.type==="ad"?"Anuncio: ":"Reproduciendo: ")+name; }
async function play(){ try{ if(!audio.src) setTrack(0); await audio.play(); if(gate) gate.style.display="none"; playBtn.textContent="‚è∏ Pausar"; playBtn.classList.remove("primary"); }catch{ if(gate) gate.style.display="flex"; } }
function pause(){ audio.pause(); playBtn.textContent="‚ñ∂ Reproducir"; playBtn.classList.add("primary"); }
function next(){ if(!playlist.length) return; setTrack(i+1); play(); }
function prev(){ if(!playlist.length) return; setTrack(i-1); play(); }
playBtn.onclick=function(){ audio.paused ? play() : pause(); };
stopBtn.onclick=function(){ audio.pause(); audio.currentTime=0; playBtn.textContent="‚ñ∂ Reproducir"; playBtn.classList.add("primary"); };
prevBtn.onclick=prev; nextBtn.onclick=next; startBtn.onclick=play;
vol.oninput=function(){ audio.volume=parseFloat(vol.value||"0.8"); }; audio.volume=parseFloat(vol.value||"0.8");
audio.addEventListener("ended", next);
</script>

<script>
// ================== CHAT + PRESENCIA (anti-fantasmas) ==================
(function(){
  if(!window.FIREBASE_ENABLED) return;

  var db=firebase.database(), auth=firebase.auth(), room="global";
  var log=$("#chatLog"), send=$("#send"), msg=$("#msg"), nick=$("#nick"),
      saveNick=$("#saveNick"), onlineEl=$("#onlineCount"),
      userName=$("#userName"), btnLogin=$("#btnLogin"), btnLogout=$("#btnLogout");

  // --- UI acceso ---
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.warn);
  

  if(btnLogin){ btnLogin.addEventListener('click', function(){
    var m=document.getElementById('authModal');
    if(m){ m.style.display='block'; var e=document.getElementById('authMsg'); if(e) e.textContent=''; }
  });}
  if(btnLogout){ btnLogout.addEventListener('click', function(){ auth.signOut().catch(console.warn); }); }

  // --- Presencia robusta ---
  var presenceRef = null;                     // ref del nodo actual
  var presenceRoomRef = db.ref("presence/"+room);
  var infoRef = db.ref(".info/connected");
  var HEARTBEAT_MS = 15000;                   // latido cada 15s
  var ACTIVE_WINDOW_MS = 60000;               // activos = latido < 60s
  var hbTimer = null;
  var lastUid = null;

  function heartbeat(){
    try{ presenceRef.update({ ts: firebase.database.ServerValue.TIMESTAMP }); }catch(e){}
  }

  function detachPresence(){
    try{
      if (hbTimer){ clearInterval(hbTimer); hbTimer=null; }
      if (presenceRef){
        // cancela onDisconnect y borra best-effort
        presenceRef.onDisconnect().cancel().catch(function(){});
        presenceRef.remove().catch(function(){});
        presenceRef = null;
      }
    }catch(e){}
  }

  function forceDisconnectCycle(cb){
    // Fuerza que el servidor dispare onDisconnect del nodo anterior
    try{ db.goOffline(); }catch(e){}
    setTimeout(function(){ try{ db.goOnline(); }catch(e){} if(cb) cb(); }, 300);
  }

  function attachPresence(user){
    if (!user) return;
    lastUid = user.uid;
    presenceRef = db.ref("presence/"+room+"/"+lastUid);

    infoRef.on("value", function(snap){
      if (snap.val() === true){
        presenceRef.onDisconnect().remove().catch(function(){});
        var nickname = user.isAnonymous ? "Visitante" : (user.displayName || (user.email||"").split('@')[0] || "Usuario");
        var prov = user.isAnonymous ? "anon" : ((user.providerData[0] && user.providerData[0].providerId) || "email");
        presenceRef.set({
          nick: nickname,
          prov: prov,
          online: true,
          ts: firebase.database.ServerValue.TIMESTAMP
        }).catch(function(){});
      }
    });

    // Heartbeat para mantener vivo y filtrar fantasmas
    hbTimer = setInterval(heartbeat, HEARTBEAT_MS);
    setTimeout(heartbeat, 1200); // primer latido r√°pido

    // Intento extra de limpieza al cerrar pesta√±a
    window.addEventListener("beforeunload", function(){
      try{ presenceRef.remove(); }catch(e){}
    });
  }

  auth.onAuthStateChanged(function(user){
    // 1) Limpia presencia anterior (y ‚Äúcorta‚Äù conexi√≥n para que onDisconnect se ejecute)
    detachPresence();
    forceDisconnectCycle(function(){
      // 2) UI
      if(!user){
        userName.style.display='none'; userName.textContent="";
        btnLogin.style.display='inline-block'; btnLogout.style.display='none';
        if(msg){ msg.disabled=true; msg.placeholder="Entra para chatear (Google / Email)"; }
        return;
      }
      
    if(user.isAnonymous){
      userName.style.display='none'; btnLogin.style.display='inline-block'; btnLogout.style.display='none';
      if(msg){ msg.disabled=true; msg.placeholder='Entra para chatear (Google / Email)'; }
      return;
    }
var name = user.displayName || (user.email?user.email.split('@')[0]:"Visitante");
      if(user.isAnonymous){ userName.style.display='none'; }
      else { userName.style.display='inline'; userName.textContent="Hola, "+name; }
      btnLogin.style.display = user.isAnonymous ? 'inline-block' : 'none';
      btnLogout.style.display= user.isAnonymous ? 'none'        : 'inline-block';
      if(msg) msg.disabled = (!user || user.isAnonymous);

      // 3) Adjunta presencia para el UID actual
      attachPresence(user);
    });
  });

  // Contador online: ignora entradas sin ts num√©rico o con ts viejo
  presenceRoomRef.on("value", function(snap){
    var v = snap.val() || {};
    var now = Date.now();
    var active = 0;

    Object.keys(v).forEach(function(uid){
      var o = v[uid] || {};
      // Si a√∫n no hay n√∫mero (placeholder de ServerValue), cuenta de forma optimista solo si online==true
      if (typeof o.ts !== "number"){
        if (o.online === true) active++;
        return;
      }
      if (now - o.ts < ACTIVE_WINDOW_MS) active++;
    });

    if(onlineEl) onlineEl.textContent = "¬∑ " + active + " conectado" + (active===1?"":"s");
  });

  // --- Chat (igual) ---
  var messagesRef = db.ref("rooms/"+room+"/messages");
  messagesRef.limitToLast(100).on("child_added", function(s){
    var o=s.val(); if(!o) return; var p=document.createElement("div");
    p.textContent = "["+(o.t||"")+"] "+(o.u||"") + ": " + (o.m||"");
    log.appendChild(p); log.scrollTop=log.scrollHeight;
  });

  function getNick(){
    var n=(nick.value||localStorage.getItem("ivanplay_nick")||"").trim();
    if(!n) n="User"+Math.floor(Math.random()*900+100);
    nick.value=n; localStorage.setItem("ivanplay_nick",n); return n;
  }
  saveNick.onclick=function(){
    localStorage.setItem("ivanplay_nick",getNick());
    var p=document.createElement("div"); p.textContent="[Sistema] Nick guardado"; log.appendChild(p);
  };

  async function sendFirebase(){
    var user=auth.currentUser;
    if(!user || user.isAnonymous){
      var m=document.getElementById('authModal'); if(m) m.style.display='block';
      return;
    }
    var txt=(msg.value||"").trim(); if(!txt) return;
    var o={ t:new Date().toLocaleTimeString(), u:getNick(), m:txt };
    await messagesRef.push(o); msg.value="";
  }
  send.onclick=sendFirebase;
  msg.onkeydown=function(e){ if((e.ctrlKey||e.metaKey) && e.key==="Enter") sendFirebase(); };
})();
</script>

<div id="authModal" class="card" style="display:none;position:fixed;inset:0;max-width:360px;margin:auto;background:#0f1222;z-index:9999">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
    <h3 style="margin:0">Entrar para chatear</h3><button id="authClose" class="btn" onclick="this.closest('#authModal').style.display='none'">‚úï</button>
  </div>
  <div style="margin-top:12px;display:grid;gap:8px">
    <button id="loginGoogle" class="btn primary">Continuar con Google</button>
    <div class="muted" style="text-align:center;margin:6px 0">‚Äî o con correo ‚Äî</div>
    <input id="authEmail" type="email" placeholder="Email"><input id="authPass" type="password" placeholder="Contrase√±a">
    <div class="row" style="gap:8px"><button id="loginEmail" class="btn">Entrar</button><button id="signupEmail" class="btn">Crear cuenta</button></div>
    <p id="authMsg" class="muted" style="margin:4px 0 0"></p>
  </div>
</div>

<script>
(function(){
  if(!window.FIREBASE_ENABLED) return;
  var auth=firebase.auth(); var msgBox=document.getElementById('authMsg');
  var inEmail=document.getElementById('authEmail'), inPass=document.getElementById('authPass');
  var googleProv=new firebase.auth.GoogleAuthProvider();
  async function signInWithGoogleSmart(){
    try{ await auth.signInWithPopup(googleProv); document.getElementById('authModal').style.display='none'; }
    catch(e){
      var code=e&&e.code?String(e.code):"";
      if(code.indexOf('popup-blocked')>=0||code.indexOf('popup-closed')>=0){
        try{ await auth.signInWithRedirect(googleProv); }catch(err){ if(msgBox) msgBox.textContent="Google (redirect): "+(err&&err.message?err.message:err); }
      }else{ if(msgBox) msgBox.textContent="Google: "+(e&&e.message?e.message:e); }
    }
  }
  var btnG=document.getElementById('loginGoogle'); if(btnG){ btnG.addEventListener('click', signInWithGoogleSmart); }
  var btnIn=document.getElementById('loginEmail'); if(btnIn){ btnIn.addEventListener('click', async function(){ try{ await auth.signInWithEmailAndPassword(inEmail.value.trim(), inPass.value); document.getElementById('authModal').style.display='none'; }catch(e){ if(msgBox) msgBox.textContent="Email/contrase√±a: "+(e&&e.message?e.message:e); } }); }
  var btnUp=document.getElementById('signupEmail'); if(btnUp){ btnUp.addEventListener('click', async function(){ try{ var cred=await auth.createUserWithEmailAndPassword(inEmail.value.trim(), inPass.value); var name=inEmail.value.split('@')[0]; await cred.user.updateProfile({displayName:name}); document.getElementById('authModal').style.display='none'; }catch(e){ if(msgBox) msgBox.textContent="Crear cuenta: "+(e&&e.message?e.message:e); } }); }
})();
</script>

<script>
(function(){
  var isMobile=window.matchMedia('(max-width: 600px)').matches;
  if(!isMobile) return;
  if(sessionStorage.getItem('adGateShown')==='1') return;
  var gate=document.getElementById('adGate'), closeB=document.getElementById('adGateClose'), label=document.getElementById('adGateCountdown');
  var body=document.body, mount=document.getElementById('adGateMount'), desktop=document.getElementById('ad-desktop-top');
  var cont=document.getElementById('container-715307b74d25ae971c432e0fec096290');
  if(cont && mount) mount.appendChild(cont);
  function enableClose(){ if(closeB.disabled){ closeB.disabled=false; closeB.classList.add('enabled'); closeB.addEventListener('click', closeGate, {once:true}); } }
  function closeGate(){ try{ if(cont && desktop) desktop.appendChild(cont); }catch(e){} gate.remove(); body.style.overflow=''; sessionStorage.setItem('adGateShown','1'); clearInterval(iv); clearTimeout(fs); if(ob) ob.disconnect(); }
  body.style.overflow='hidden'; gate.classList.add('show');
  var secs=5; label.textContent=secs; var iv=setInterval(function(){ secs=Math.max(0,secs-1); label.textContent=secs; if(secs===0) enableClose(); },1000);
  var ob=new MutationObserver(function(){ if(mount.querySelector('iframe')||mount.querySelector('ins')) enableClose(); });
  if(mount) ob.observe(mount,{childList:true,subtree:true});
  var fs=setTimeout(enableClose,6000);
  window.addEventListener('resize', function(){ if(!window.matchMedia('(max-width: 600px)').matches) closeGate(); });
})();
</script>

<script>
var LS_TODAY="ivanplay_stats_today",LS_TODAY_D="ivanplay_stats_today_date",LS_TOTAL="ivanplay_stats_total";
function statResetIfDayChanged(){ var today=new Date().toISOString().slice(0,10); var saved=localStorage.getItem(LS_TODAY_D); if(saved!==today){ localStorage.setItem(LS_TODAY_D,today); localStorage.setItem(LS_TODAY,"0"); } }
function statIncToday(){ statResetIfDayChanged(); var v=parseInt(localStorage.getItem(LS_TODAY)||"0",10)+1; localStorage.setItem(LS_TODAY,String(v)); updateStatsUI(); }
function statIncTotal(){ var v=parseInt(localStorage.getItem(LS_TOTAL)||"0",10)+1; localStorage.setItem(LS_TOTAL,String(v)); updateStatsUI(); }
function updateStatsUI(){ var t=parseInt(localStorage.getItem(LS_TODAY)||"0",10), g=parseInt(localStorage.getItem(LS_TOTAL)||"0",10); var $t=document.querySelector("#statToday"), $g=document.querySelector("#statTotalLocal"); if($t) $t.textContent=t; if($g) $g.textContent=g; }
statResetIfDayChanged(); updateStatsUI();
(async function(){ try{ var ns=CONFIG.COUNTAPI_NAMESPACE, key=CONFIG.COUNTAPI_KEY, el=document.querySelector("#statVisits"); if(!ns||!key||!el){ if(el) el.textContent="‚Äî"; return; } var url="https://api.countapi.xyz/hit/"+encodeURIComponent(ns)+"/"+encodeURIComponent(key); var r=await fetch(url,{cache:"no-store"}); var j=await r.json(); el.textContent=(j&&typeof j.value==="number")?j.value:"‚Äî"; }catch(e){ var el2=document.querySelector("#statVisits"); if(el2) el2.textContent="‚Äî"; } })();
</script>

<script>
// Compartir
(function(){
  var url  = "https://ivanplaysyt.github.io/";
  var text = "üéß Radio IVANPLAY ‚Äî m√∫sica 24/7. ¬°Entra ya!";
  var title= "Radio IVANPLAY";
  var $btn=document.getElementById("shareBtn"), $wa=document.getElementById("shareWa"), $tg=document.getElementById("shareTg"), $tw=document.getElementById("shareTw");
  if ($btn){ $btn.onclick = async function(){ try{ if(navigator.share){ await navigator.share({title:title,text:text,url:url}); return; } }catch(e){} try{ await navigator.clipboard.writeText(url); $btn.textContent="Copiado ‚úÖ"; setTimeout(function(){ $btn.textContent="üîó Compartir"; },1500);}catch(e){} }; }
  if ($wa) $wa.href="https://wa.me/?text="+encodeURIComponent(text+" "+url);
  if ($tg) $tg.href="https://t.me/share/url?url="+encodeURIComponent(url)+"&text="+encodeURIComponent(text);
  if ($tw) $tw.href="https://twitter.com/intent/tweet?text="+encodeURIComponent(text)+"&url="+encodeURIComponent(url);
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>RADIO IVANPLAY ¬∑ Juegos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="./assets/favicon.ico">
  <style>
    :root{
      --bg:#0b0d12;
      --card:#111421;
      --text:#e7ecf3;
      --muted:#94a0b8;
      --a:#8b5cf6;
      --btn:#1f2435;
    }
    body{
      margin:0;
      background:
        linear-gradient(180deg, rgba(7,10,18,.85), rgba(7,10,18,.95)),
        url('./assets/bg/ivanplay_gamer_bg.jpg') center/cover fixed no-repeat;
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
      min-height:100vh;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 20px;
      background:#090b10d9;
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .brand h1{
      font-size:18px;
      margin:0;
    }
    .top-links a{
      color:var(--text);
      background:rgba(255,255,255,.05);
      padding:7px 12px;
      border-radius:10px;
      text-decoration:none;
      font-size:14px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }
    h2{margin-top:0}
    .grid-games{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px,1fr));
      gap:16px;
      margin-top:16px;
    }
    .card{
      background:rgba(16,19,30,.75);
      border:1px solid rgba(255,255,255,.05);
      border-radius:16px;
      padding:14px;
      backdrop-filter:blur(4px);
    }
    .game-title{font-weight:700;margin-bottom:4px;}
    .muted{color:var(--muted);font-size:13px;}
    button.btn{
      border:0;
      background:linear-gradient(180deg,#8b5cf6,#5b3dff);
      color:#fff;
      padding:6px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      margin-top:6px;
    }
    #gameArea canvas{max-width:100%;height:auto;}
    /* cartas */
    .card-spanish{box-shadow:0 4px 10px rgba(0,0,0,.4);}
    .cards-flex{display:flex;gap:6px;flex-wrap:wrap;}
    footer{margin:20px 0;text-align:center;color:var(--muted);font-size:12px;}
    @media(max-width:600px){
      .top-links{display:flex;gap:8px;}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div style="width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#6a5cf6,#24d3ee);display:grid;place-items:center">üéÆ</div>
      <h1>Juegos ¬∑ RADIO IVANPLAY</h1>
    </div>
    <div class="top-links">
      <a href="./index.html">‚Üê Volver a la radio</a>
      <a href="#" onclick="alert('üõ†Ô∏è Esta p√°gina est√° en construcci√≥n.\nPronto a√±adiremos nuevas recompensas y funciones.');return false;">Tienda</a>
    </div>
  </header>

  <main class="wrap">
    <h2>Juegos b√°sicos</h2>
    <p class="muted">Juega aqu√≠. Si hay otro usuario conectado entr√°is en la misma sala. Si no hay nadie, entra un bot. Los ganadores reciben puntos de la radio.</p>

    <div class="grid-games" id="gamesList">
      <div class="card">
        <div class="game-title">üé± Billar 8-ball</div>
        <p class="muted">1 vs 1 online o contra bot. Lisas vs rayadas. Gana metiendo la 8 al final.</p>
        <button class="btn" onclick="loadGame('billar')">Jugar</button>
      </div>
      <div class="card">
        <div class="game-title">üÉè Cartas (baraja espa√±ola)</div>
        <p class="muted">Hasta 4 jugadores. Si no hay gente se rellenan con bots.</p>
        <button class="btn" onclick="loadGame('cartas')">Jugar</button>
      </div>
      <div class="card">
        <div class="game-title">‚úä Piedra ¬∑ Papel ¬∑ Tijera</div>
        <p class="muted">Cl√°sico contra bot.</p>
        <button class="btn" onclick="loadGame('ppt')">Jugar</button>
      </div>
      <div class="card">
        <div class="game-title">üî¢ Adivina el n√∫mero</div>
        <p class="muted">Tienes 6 intentos.</p>
        <button class="btn" onclick="loadGame('guess')">Jugar</button>
      </div>
      <div class="card">
        <div class="game-title">‚ö° Reflejos</div>
        <p class="muted">Haz clic cuando se ponga en verde.</p>
        <button class="btn" onclick="loadGame('reflex')">Jugar</button>
      </div>
      <div class="card">
        <div class="game-title">üêç Snake mini</div>
        <p class="muted">Recoge comida, no choques.</p>
        <button class="btn" onclick="loadGame('snake')">Jugar</button>
      </div>
    </div>

    <section id="gameArea" class="card" style="margin-top:20px;min-height:260px;">
      <p class="muted">Elige un juego de arriba.</p>
    </section>
  </main>

  <footer>¬© 2025 RADIO IVANPLAY ¬∑ Juegos</footer>

  <!-- Firebase CDN (igual que en index) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
  // ====== MISMA CONFIG QUE LA RADIO (ajusta si cambiaste algo) ======
  const FIREBASE_CONFIG = {
    apiKey:        "AIzaSyAIlX6svUMeb1_Q0Mn4WvxojDDTqtIYXv0",
    authDomain:    "ivanplayradio.firebaseapp.com",
    databaseURL:   "https://ivanplayradio-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId:     "ivanplayradio",
    storageBucket: "ivanplayradio.firebasestorage.app",
    messagingSenderId: "114410018389",
    appId:         "1:114410018389:web:1d8c40b5baf8c51673e6dc"
  };
  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db   = firebase.database();

  // usuario actual (igual que en index)
  let currentUser = null;
  auth.onAuthStateChanged(u=>{
    currentUser = u;
  });

  // ========== MATCHMAKING SENCILLO ==========
  const ROOMS_REF = db.ref('gameRooms');
  async function joinOrCreateRoom(gameId, me){
    const snap = await ROOMS_REF.child(gameId).orderByChild('status').equalTo('waiting').limitToFirst(1).get();
    let roomKey = null;
    if (snap.exists()){
      const itemKey = Object.keys(snap.val())[0];
      roomKey = itemKey;
      await ROOMS_REF.child(gameId).child(roomKey).child('players').child(me.uid).set({
        nick: me.displayName || (me.email||'')[0] || 'Jugador',
        ts: firebase.database.ServerValue.TIMESTAMP
      });
      await ROOMS_REF.child(gameId).child(roomKey).update({
        status:'playing',
        startedAt: firebase.database.ServerValue.TIMESTAMP
      });
    } else {
      const newRef = ROOMS_REF.child(gameId).push();
      roomKey = newRef.key;
      await newRef.set({
        status:'waiting',
        owner: me.uid,
        players: {
          [me.uid]: {
            nick: me.displayName || (me.email||'')[0] || 'Jugador',
            ts: firebase.database.ServerValue.TIMESTAMP
          }
        },
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
    }
    return roomKey;
  }

  // ========== CARGAR JUEGO ========== 
  function loadGame(kind){
    const area = document.getElementById('gameArea');
    area.innerHTML = '';
    const container = document.createElement('div');
    area.appendChild(container);

    /* ================== BILLAR 8-BALL ONLINE + BOT ================== */
    if (kind === 'billar') {
      const info = document.createElement('p');
      info.className = 'muted';
      info.textContent = 'üé± Billar 8-ball ‚Äî conectando...';
      const canvas = document.createElement('canvas');
      canvas.width = 560;
      canvas.height = 310;
      canvas.style.background = '#044322';
      canvas.style.borderRadius = '14px';
      canvas.style.display = 'block';
      canvas.style.margin = 'auto';
      container.appendChild(info);
      container.appendChild(canvas);
      const ctx = canvas.getContext('2d');

      const POCKETS = [
        {x:20,y:20,r:15},
        {x:canvas.width/2,y:10,r:15},
        {x:canvas.width-20,y:20,r:15},
        {x:20,y:canvas.height-20,r:15},
        {x:canvas.width/2,y:canvas.height-10,r:15},
        {x:canvas.width-20,y:canvas.height-20,r:15},
      ];
      const BALL_COLORS = {
        1:"#ffdf00", 2:"#0047ff", 3:"#ff5900", 4:"#5d2aff", 5:"#ff008c", 6:"#00a86b", 7:"#8b4513",
        9:"#ffdf00", 10:"#0047ff", 11:"#ff5900", 12:"#5d2aff", 13:"#ff008c", 14:"#00a86b", 15:"#8b4513",
        8:"#000000"
      };

      function makeInitialState(){
        const R = 9;
        const balls = [];
        balls.push({id:'cue', num:0, x:120, y:canvas.height/2, vx:0, vy:0, r:R, color:'#fff', alive:true});
        const baseX = 380;
        const baseY = canvas.height/2;
        const order = [1,9,2,10,8,3,11,7,14,4,12,5,13,15,6];
        let idx = 0;
        for (let row=0; row<5; row++){
          for (let col=0; col<=row; col++){
            const num = order[idx++];
            const offX = row * (R*2 + 1);
            const offY = -row*R + col*(R*2);
            balls.push({
              id:'b'+num, num,
              x: baseX + offX,
              y: baseY + offY,
              vx:0, vy:0, r:R,
              color: BALL_COLORS[num] || '#ccc',
              alive:true
            });
          }
        }
        return { balls, assigned:null, turn:null, winner:null };
      }

      function drawTable(state, myUid){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#044322';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#000';
        POCKETS.forEach(p=>{
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        });
        if (!state || !state.balls) return;
        state.balls.forEach(b=>{
          if (!b.alive) return;
          ctx.beginPath();
          ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
          ctx.fillStyle = b.color;
          ctx.fill();
          if (b.num>=9 && b.num<=15){
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(b.x-b.r+3, b.y);
            ctx.lineTo(b.x+b.r-3, b.y);
            ctx.stroke();
          }
          if (b.num){
            ctx.fillStyle = '#fff';
            ctx.font = '10px system-ui';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(String(b.num), b.x, b.y);
          }
          if (b.id==='cue' && state.turn === myUid){
            ctx.strokeStyle = '#00ff7f';
            ctx.lineWidth = 2;
            ctx.stroke();
          }
        });
      }

      function stepPhysics(state){
        const fric = 0.99;
        const balls = state.balls;
        balls.forEach(b=>{
          if (!b.alive) return;
          b.x += b.vx;
          b.y += b.vy;
          b.vx *= fric;
          b.vy *= fric;
          if (Math.abs(b.vx)<0.02) b.vx=0;
          if (Math.abs(b.vy)<0.02) b.vy=0;
          if (b.x < b.r+5){ b.x = b.r+5; b.vx*=-1; }
          if (b.x > canvas.width-b.r-5){ b.x = canvas.width-b.r-5; b.vx*=-1; }
          if (b.y < b.r+5){ b.y = b.r+5; b.vy*=-1; }
          if (b.y > canvas.height-b.r-5){ b.y = canvas.height-b.r-5; b.vy*=-1; }
        });
        // colisiones
        for (let i=0;i<balls.length;i++){
          for (let j=i+1;j<balls.length;j++){
            const a=balls[i], b=balls[j];
            if (!a.alive || !b.alive) continue;
            const dx=b.x-a.x, dy=b.y-a.y;
            const dist=Math.hypot(dx,dy);
            const minD=a.r+b.r;
            if (dist>0 && dist<minD){
              const overlap=(minD-dist)/2;
              const nx=dx/dist, ny=dy/dist;
              a.x-=nx*overlap; a.y-=ny*overlap;
              b.x+=nx*overlap; b.y+=ny*overlap;
              const tvx=a.vx, tvy=a.vy;
              a.vx=b.vx; a.vy=b.vy;
              b.vx=tvx; b.vy=tvy;
            }
          }
        }
        // embocadas
        const sunk=[];
        balls.forEach(b=>{
          if (!b.alive) return;
          for (const p of POCKETS){
            if (Math.hypot(b.x-p.x, b.y-p.y) < p.r-2){
              sunk.push(b);
            }
          }
        });
        sunk.forEach(b=>{
          if (b.id==='cue'){
            b.x = 120; b.y = canvas.height/2; b.vx=0; b.vy=0;
          } else {
            b.alive=false;
          }
        });
        return sunk;
      }

      function isMineBall(state, uid, ball){
        if (!state.assigned) return false;
        if (ball.num>=1 && ball.num<=7) return state.assigned.uidSolids === uid;
        if (ball.num>=9 && ball.num<=15) return state.assigned.uidStripes === uid;
        return false;
      }
      function playerHasCleared(state, uid){
        if (!state.assigned) return false;
        const needSolids = state.assigned.uidSolids === uid;
        const needStripes = state.assigned.uidStripes === uid;
        if (needSolids) return !state.balls.some(b=>b.alive && b.num>=1 && b.num<=7);
        if (needStripes) return !state.balls.some(b=>b.alive && b.num>=9 && b.num<=15);
        return false;
      }
      function processShotResult(state, shooterUid, sunkBalls, playersInRoom){
        if (!sunkBalls || sunkBalls.length===0){
          state.turn = playersInRoom.find(u=>u!==shooterUid) || shooterUid;
          return;
        }
        if (!state.assigned){
          const solids = sunkBalls.find(b=>b.num>=1 && b.num<=7);
          const stripes = sunkBalls.find(b=>b.num>=9 && b.num<=15);
          if (solids){
            state.assigned = {uidSolids: shooterUid, uidStripes: playersInRoom.find(u=>u!==shooterUid) || shooterUid};
          } else if (stripes){
            state.assigned = {uidStripes: shooterUid, uidSolids: playersInRoom.find(u=>u!==shooterUid) || shooterUid};
          }
        }
        const black = sunkBalls.find(b=>b.num===8);
        if (black){
          const mineCleared = playerHasCleared(state, shooterUid);
          if (mineCleared){
            state.winner = shooterUid;
          } else {
            const other = playersInRoom.find(u=>u!==shooterUid) || shooterUid;
            state.winner = other;
          }
          return;
        }
        const mineOnly = sunkBalls.every(b=>isMineBall(state, shooterUid, b));
        if (mineOnly){
          state.turn = shooterUid;
        } else {
          state.turn = playersInRoom.find(u=>u!==shooterUid) || shooterUid;
        }
      }

      (async ()=>{
        const me = currentUser;
        if (!me){ info.textContent = "Inicia sesi√≥n en la radio primero."; return; }
        const roomId = await joinOrCreateRoom('billar-1v1', me);
        const roomRef = db.ref('gameRooms/billar-1v1/'+roomId);
        info.textContent = 'Sala '+roomId+' ‚Äî esperando rival...';

        setTimeout(async ()=>{
          const snap = await roomRef.get();
          const data = snap.val() || {};
          const players = data.players ? Object.keys(data.players) : [];
          if (players.length === 1){
            await roomRef.child('players').child('BOT').set({
              nick:'ü§ñ Bot',
              ts: firebase.database.ServerValue.TIMESTAMP
            });
            if (!data.turn){
              await roomRef.update({turn: me.uid});
            }
          }
        }, 3000);

        roomRef.child('state').get().then(s=>{
          if (!s.exists()){
            roomRef.update({
              state: makeInitialState(),
              turn: me.uid,
              owner: me.uid
            });
          }
        });

        roomRef.on('value', snap=>{
          const data = snap.val(); if (!data) return;
          const state = data.state;
          const players = data.players ? Object.keys(data.players) : [];
          drawTable(state, me.uid);

          if (data.winner){
            info.textContent = (data.winner === me.uid) ? 'üèÜ Ganaste (+5 pts)' : 'Perdiste';
            if (data.winner === me.uid){
              db.ref('users/'+me.uid).transaction(d=>{
                d = d || {};
                d.pointsTotal = (d.pointsTotal||0) + 5;
                return d;
              });
            }
          } else {
            info.textContent = (state.turn === me.uid) ? 'Tu turno: haz clic en la mesa' : 'Turno del rival...';
          }

          // un empujoncito de f√≠sica si soy el owner
          if (data.owner === me.uid && !data.winner){
            const sunk = stepPhysics(state);
            roomRef.child('state').set(state);
          }

          canvas.onclick = async (e)=>{
            const cur = (await roomRef.get()).val(); if (!cur) return;
            if (cur.winner) return;
            if (cur.turn !== me.uid) return;
            const st2 = cur.state;
            const cue = st2.balls.find(b=>b.id==='cue');
            if (!cue) return;
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            const dx = mx - cue.x;
            const dy = my - cue.y;
            const len = Math.hypot(dx,dy) || 1;
            cue.vx = dx/len * 6;
            cue.vy = dy/len * 6;
            const sunk = stepPhysics(st2);
            processShotResult(st2, me.uid, sunk, players);
            await roomRef.update({ state: st2, turn: st2.turn, owner: cur.owner || me.uid, winner: st2.winner || null });
          };
        });
      })();
    }

    /* ================== CARTAS ONLINE + BOT (HASTA 4) ================== */
    else if (kind === 'cartas') {
      const info = document.createElement('p');
      info.className = 'muted';
      info.textContent = 'üÉè Cartas ‚Äî conectando...';
      const table = document.createElement('div');
      table.style.minHeight = '150px';
      table.style.background = '#111';
      table.style.borderRadius = '10px';
      table.style.padding = '10px';
      table.style.marginTop = '10px';
      container.appendChild(info);
      container.appendChild(table);

      function makeDeck(){
        const PALOS = [
          {id:'oros', icon:'üü°', cls:'oros'},
          {id:'copas', icon:'üç∑', cls:'copas'},
          {id:'espadas', icon:'üó°Ô∏è', cls:'espadas'},
          {id:'bastos', icon:'ü™µ', cls:'bastos'},
        ];
        const VALORES = ['1','2','3','4','5','6','7','10','11','12'];
        const deck=[];
        PALOS.forEach(p=>{
          VALORES.forEach(v=>{
            deck.push({v, palo:p.id, icon:p.icon, cls:p.cls});
          });
        });
        return deck;
      }
      function renderHand(title, cards){
        const wrap = document.createElement('div');
        const h = document.createElement('p');
        h.innerHTML = `<strong>${title}</strong>`;
        const row = document.createElement('div');
        row.style.display='flex'; row.style.gap='6px'; row.style.flexWrap='wrap';
        cards.forEach(c=>{
          const card = document.createElement('div');
          card.style.width='68px'; card.style.height='110px';
          card.style.background='#fff'; card.style.border='2px solid #ddd';
          card.style.borderRadius='10px';
          card.style.display='flex';
          card.style.flexDirection='column';
          card.style.justifyContent='space-between';
          card.style.padding='4px';
          card.innerHTML = `<div>${c.v}</div><div style="font-size:26px;text-align:center">${c.icon}</div><div>${c.v}</div>`;
          row.appendChild(card);
        });
        wrap.appendChild(h); wrap.appendChild(row);
        return wrap;
      }

      (async ()=>{
        const me = currentUser;
        if (!me){ info.textContent = "Inicia sesi√≥n en la radio primero."; return; }
        const roomId = await joinOrCreateRoom('cartas-mesa', me);
        const roomRef = db.ref('gameRooms/cartas-mesa/'+roomId);
        info.textContent = 'üÉè Cartas ‚Äî sala '+roomId+' (esperando jugadores...)';

        setTimeout(async ()=>{
          const snap = await roomRef.get();
          const data = snap.val() || {};
          const players = data.players ? Object.keys(data.players) : [];
          let need = 4 - players.length;
          for (let i=0;i<need;i++){
            await roomRef.child('players').child('BOT'+i).set({
              nick:'ü§ñ Bot '+(i+1),
              ts: firebase.database.ServerValue.TIMESTAMP
            });
          }
          const st = await roomRef.child('state').get();
          if (!st.exists()){
            const deck = makeDeck().sort(()=>Math.random()-.5);
            const fresh = { hands:{}, turn:null, winner:null };
            const playersNow = (await roomRef.get()).val().players;
            const ids = Object.keys(playersNow);
            ids.forEach(id=>{
              fresh.hands[id] = deck.splice(0,3);
            });
            fresh.turn = ids[0];
            await roomRef.child('state').set(fresh);
          }
        }, 3000);

        roomRef.on('value', snap=>{
          const data = snap.val() || {};
          const players = data.players || {};
          const state = data.state || {};
          table.innerHTML = '';
          const ids = Object.keys(players);
          ids.forEach(pid=>{
            const hand = (state.hands && state.hands[pid]) ? state.hands[pid] : [];
            table.appendChild(renderHand(players[pid].nick || pid, hand));
          });
          if (state.winner){
            info.textContent = (state.winner === me.uid) ? 'üèÜ Ganaste (+5 pts)' : 'Gan√≥ '+(players[state.winner]?.nick || state.winner);
            if (state.winner === me.uid){
              db.ref('users/'+me.uid).transaction(d=>{
                d = d || {};
                d.pointsTotal = (d.pointsTotal||0) + 5;
                return d;
              });
            }
          } else {
            info.textContent = 'üÉè Sala '+roomId+' ¬∑ turno de: '+(players[state.turn]?.nick || state.turn || '...');
          }
        });

        table.onclick = async ()=>{
          const snap = await roomRef.get(); const data = snap.val() || {};
          const state = data.state || {};
          if (state.winner) return;
          if (state.turn !== currentUser.uid) return;
          const myHand = (state.hands && state.hands[currentUser.uid]) ? state.hands[currentUser.uid] : [];
          if (!myHand.length) return;
          const best = myHand.slice().sort((a,b)=>Number(b.v)-Number(a.v))[0];
          const newHand = myHand.filter(c=> !(c.v===best.v && c.palo===best.palo));
          state.hands[currentUser.uid] = newHand;
          const players = Object.keys(data.players||{});
          const idx = players.indexOf(currentUser.uid);
          const next = players[(idx+1)%players.length];
          state.turn = next;
          const allEmpty = players.every(pid=> (state.hands[pid]||[]).length===0);
          if (allEmpty){
            state.winner = currentUser.uid;
          }
          await roomRef.child('state').set(state);
        };
      })();
    }

    /* ================== OTROS MINI JUEGOS LOCALES ================== */
    else if (kind === 'ppt') {
      const title = document.createElement('p');
      title.className = 'muted';
      title.textContent = 'Elige:';
      const row = document.createElement('div');
      ['Piedra','Papel','Tijera'].forEach(opt=>{
        const b=document.createElement('button'); b.className='btn'; b.textContent=opt;
        b.onclick=()=>{
          const bot = ['Piedra','Papel','Tijera'][Math.floor(Math.random()*3)];
          let res='Empate';
          if ((opt==='Piedra' && bot==='Tijera')||(opt==='Papel' && bot==='Piedra')||(opt==='Tijera' && bot==='Papel')){
            res='Ganaste';
            if (currentUser){
              db.ref('users/'+currentUser.uid).transaction(d=>{
                d=d||{}; d.pointsTotal=(d.pointsTotal||0)+2; return d;
              });
            }
          } else if (opt!==bot){
            res='Perdiste';
          }
          alert(opt+' vs '+bot+' ‚Üí '+res);
        };
        row.appendChild(b);
      });
      container.appendChild(title);
      container.appendChild(row);
    }
    else if (kind === 'guess'){
      const p=document.createElement('p'); p.className='muted'; p.textContent='Adivina n√∫mero 1-30. Tienes 6 intentos.';
      const input=document.createElement('input'); input.type='number'; input.min='1'; input.max='30';
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Probar';
      const msg=document.createElement('p'); msg.className='muted';
      const secret = Math.floor(Math.random()*30)+1;
      let tries=6;
      btn.onclick=()=>{
        const v=Number(input.value);
        if (!v) return;
        tries--;
        if (v===secret){
          msg.textContent='‚úî Acierto';
          if (currentUser){
            db.ref('users/'+currentUser.uid).transaction(d=>{
              d=d||{}; d.pointsTotal=(d.pointsTotal||0)+3; return d;
            });
          }
        } else if (tries<=0){
          msg.textContent='‚ùå Sin intentos. Era '+secret;
        } else {
          msg.textContent = v<secret ? 'M√°s alto. Intentos: '+tries : 'M√°s bajo. Intentos: '+tries;
        }
      };
      container.appendChild(p); container.appendChild(input); container.appendChild(btn); container.appendChild(msg);
    }
    else if (kind === 'reflex'){
      const box=document.createElement('div');
      box.style.height='140px'; box.style.borderRadius='16px'; box.style.display='grid'; box.style.placeItems='center';
      box.style.background='#333';
      box.textContent='Espera al verde...';
      let ready=false;
      let start=0;
      setTimeout(()=>{
        box.style.background='#1abc9c';
        box.textContent='¬°CLICA!';
        ready=true;
        start=performance.now();
      }, 1000+Math.random()*3000);
      box.onclick=()=>{
        if (!ready) return;
        const t = performance.now()-start;
        box.textContent='Tiempo: '+t.toFixed(0)+' ms';
        if (currentUser){
          db.ref('users/'+currentUser.uid).transaction(d=>{
            d=d||{}; d.pointsTotal=(d.pointsTotal||0)+1; return d;
          });
        }
      };
      container.appendChild(box);
    }
    else if (kind === 'snake'){
      const c=document.createElement('canvas'); c.width=320; c.height=240; c.style.background='#000';
      container.appendChild(c);
      const x=c.getContext('2d');
      const size=10;
      let snake=[{x:10,y:10}];
      let dir={x:1,y:0};
      let food={x:15,y:10};
      let alive=true;

      document.onkeydown=(e)=>{
        if (e.key==='ArrowUp' && dir.y===0) dir={x:0,y:-1};
        else if (e.key==='ArrowDown' && dir.y===0) dir={x:0,y:1};
        else if (e.key==='ArrowLeft' && dir.x===0) dir={x:-1,y:0};
        else if (e.key==='ArrowRight' && dir.x===0) dir={x:1,y:0};
      };
      function loop(){
        if (!alive) return;
        const head={x:snake[0].x+dir.x, y:snake[0].y+dir.y};
        if (head.x<0||head.y<0||head.x>=c.width/size||head.y>=c.height/size){
          alive=false; return;
        }
        if (snake.some(s=>s.x===head.x && s.y===head.y)){
          alive=false; return;
        }
        snake.unshift(head);
        if (head.x===food.x && head.y===food.y){
          food={x:Math.floor(Math.random()* (c.width/size)), y:Math.floor(Math.random()*(c.height/size))};
          if (currentUser){
            db.ref('users/'+currentUser.uid).transaction(d=>{
              d=d||{}; d.pointsTotal=(d.pointsTotal||0)+1; return d;
            });
          }
        } else {
          snake.pop();
        }
        x.clearRect(0,0,c.width,c.height);
        x.fillStyle='#0f0';
        snake.forEach(s=> x.fillRect(s.x*size, s.y*size, size-1, size-1));
        x.fillStyle='#f00';
        x.fillRect(food.x*size, food.y*size, size-1, size-1);
        requestAnimationFrame(loop);
      }
      loop();
    }
  }
  </script>
</body>
</html>
